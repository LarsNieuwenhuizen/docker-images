##
## baseimage
##
FROM debian:buster-slim AS base

ARG PHP_VERSION=7.4
ARG LATEST_PHP_VERSION=8.1
ARG DEBIAN_FRONTEND=noninteractive

COPY entrypoints /opt/local/entrypoints
COPY installers /opt/local/installers

RUN /opt/local/installers/${PHP_VERSION}.sh; \
    rm -rf /opt/local/installers; \
    update-alternatives --set php /usr/bin/php${PHP_VERSION}

RUN if [ "$PHP_VERSION" != "$LATEST_PHP_VERSION" ]; then \
    apt-get purge -y php${LATEST_PHP_VERSION}*; \
fi

##
## development images
##
FROM base AS development

ARG PHP_VERSION=7.4
ARG DEBIAN_FRONTEND=noninteractive

# Install composer
COPY --from=composer:2.2 /usr/bin/composer /usr/bin/composer

ENV COMPOSER_CACHE_DIR="/var/cache/composer"
ENV COMPOSER_ALLOW_SUPERUSER 1

RUN set -eux; \
    apt-get update; \
    apt-get install -y \
        php${PHP_VERSION}-xdebug git; \
    apt-get autoremove -y; \
    apt-get clean -y; \
    rm -rf /var/lib/apt/lists/*; \
    composer global require "squizlabs/php_codesniffer"; \
    composer global require "phpunit/phpunit"; \
    composer global require "localheinz/composer-normalize"; \
    rm -rf /var/cache/composer/*; \
    chmod -R 777 /var/cache/composer

COPY php-fpm-pool.conf /etc/php/${PHP_VERSION}/fpm/pool.d/www.conf
COPY php.ini /etc/php/${PHP_VERSION}/conf.d/9999-php.ini

ENTRYPOINT ["/opt/local/entrypoints/cli.sh"]

FROM base AS production

ENTRYPOINT ["/usr/bin/php"]

MAINTAINER Lars Nieuwenhuizen
